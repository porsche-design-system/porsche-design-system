const aws = require('aws-sdk');
const AthenaExpress = require('athena-express');

const awsCredentials = {
  region: 'eu-central-1',
};
aws.config.update(awsCredentials);

const athenaExpressConfig = { aws };
const athenaExpress = new AthenaExpress(athenaExpressConfig);

exports.handler = async (event) => {
  console.log('Start creating new Athena partition');

  const input =
    'Partitions not in metastore:\ttracking_data:2020/06/22\ttracking_data:2020/06/23\ttracking_data:2020/06/24\ttracking_data:2020/06/25\ttracking_data:2020/06/26\ttracking_data:2020/06/27\ttracking_data:2020/06/28\ttracking_data:2020/06/29\ttracking_data:2020/06/30\ttracking_data:2020/07/01\ttracking_data:2020/07/02\ttracking_data:2020/07/03\ttracking_data:2020/07/04\ttracking_data:2020/07/05\ttracking_data:2020/07/06\ttracking_data:2020/07/07\ttracking_data:2020/07/08\ttracking_data:2020/07/09\ttracking_data:2020/07/10\ttracking_data:2020/07/11\ttracking_data:2020/07/12\ttracking_data:2020/07/13\ttracking_data:2020/07/14\ttracking_data:2020/07/15\ttracking_data:2020/07/16\ttracking_data:2020/07/17\ttracking_data:2020/07/18\ttracking_data:2020/07/19\ttracking_data:2020/07/20\ttracking_data:2020/07/21\ttracking_data:2020/07/22\ttracking_data:2020/07/23\ttracking_data:2020/07/24\ttracking_data:2020/07/25\ttracking_data:2020/07/26\ttracking_data:2020/07/27\ttracking_data:2020/07/28\ttracking_data:2020/07/29\ttracking_data:2020/07/30\ttracking_data:2020/07/31\ttracking_data:2020/08/01\ttracking_data:2020/08/02\ttracking_data:2020/08/03\ttracking_data:2020/08/04\ttracking_data:2020/08/05\ttracking_data:2020/08/06\ttracking_data:2020/08/07\ttracking_data:2020/08/08\ttracking_data:2020/08/09\ttracking_data:2020/08/10\ttracking_data:2020/08/11\ttracking_data:2020/08/12\ttracking_data:2020/08/13\ttracking_data:2020/08/14\ttracking_data:2020/08/15\ttracking_data:2020/08/16\ttracking_data:2020/08/17\ttracking_data:2020/08/18\ttracking_data:2020/08/19\ttracking_data:2020/08/20\ttracking_data:2020/08/21\ttracking_data:2020/08/22\ttracking_data:2020/08/23\ttracking_data:2020/08/24\ttracking_data:2020/08/25\ttracking_data:2020/08/26\ttracking_data:2020/08/27\ttracking_data:2020/08/28\ttracking_data:2020/08/29\ttracking_data:2020/08/30\ttracking_data:2020/08/31\ttracking_data:2020/09/01\ttracking_data:2020/09/02\ttracking_data:2020/09/03\ttracking_data:2020/09/04\ttracking_data:2020/09/05\ttracking_data:2020/09/06\ttracking_data:2020/09/07\ttracking_data:2020/09/08\ttracking_data:2020/09/09\ttracking_data:2020/09/10\ttracking_data:2020/09/11\ttracking_data:2020/09/12\ttracking_data:2020/09/13\ttracking_data:2020/09/14\ttracking_data:2020/09/15\ttracking_data:2020/09/16\ttracking_data:2020/09/17\ttracking_data:2020/09/18\ttracking_data:2020/09/19\ttracking_data:2020/09/20\ttracking_data:2020/09/21\ttracking_data:2020/09/22\ttracking_data:2020/09/23\ttracking_data:2020/09/24\ttracking_data:2020/09/25\ttracking_data:2020/09/26\ttracking_data:2020/09/27\ttracking_data:2020/09/28\ttracking_data:2020/09/29\ttracking_data:2020/09/30\ttracking_data:2020/10/01\ttracking_data:2020/10/02\ttracking_data:2020/10/03\ttracking_data:2020/10/04\ttracking_data:2020/10/05\ttracking_data:2020/10/06\ttracking_data:2020/10/07\ttracking_data:2020/10/08\ttracking_data:2020/10/09\ttracking_data:2020/10/10\ttracking_data:2020/10/11\ttracking_data:2020/10/12\ttracking_data:2020/10/13\ttracking_data:2020/10/14\ttracking_data:2020/10/15\ttracking_data:2020/10/16\ttracking_data:2020/10/17\ttracking_data:2020/10/18\ttracking_data:2020/10/19\ttracking_data:2020/10/20\ttracking_data:2020/10/21\ttracking_data:2020/10/22\ttracking_data:2020/10/23\ttracking_data:2020/10/24\ttracking_data:2020/10/25\ttracking_data:2020/10/26\ttracking_data:2020/10/27\ttracking_data:2020/10/28\ttracking_data:2020/10/29\ttracking_data:2020/10/30\ttracking_data:2020/10/31\ttracking_data:2020/11/01\ttracking_data:2020/11/02\ttracking_data:2020/11/03\ttracking_data:2020/11/04\ttracking_data:2020/11/05\ttracking_data:2020/11/06\ttracking_data:2020/11/07\ttracking_data:2020/11/08\ttracking_data:2020/11/09\ttracking_data:2020/11/10\ttracking_data:2020/11/11\ttracking_data:2020/11/12\ttracking_data:2020/11/13\ttracking_data:2020/11/14\ttracking_data:2020/11/15\ttracking_data:2020/11/16\ttracking_data:2020/11/17\ttracking_data:2020/11/18\ttracking_data:2020/11/19\ttracking_data:2020/11/20\ttracking_data:2020/11/21\ttracking_data:2020/11/22\ttracking_data:2020/11/23\ttracking_data:2020/11/24\ttracking_data:2020/11/25\ttracking_data:2020/11/26\ttracking_data:2020/11/27\ttracking_data:2020/11/28\ttracking_data:2020/11/29\ttracking_data:2020/11/30\ttracking_data:2020/12/01\ttracking_data:2020/12/02\ttracking_data:2020/12/03\ttracking_data:2020/12/04\ttracking_data:2020/12/05\ttracking_data:2020/12/06\ttracking_data:2020/12/07\ttracking_data:2020/12/08\ttracking_data:2020/12/09\ttracking_data:2020/12/10\ttracking_data:2020/12/11\ttracking_data:2020/12/12\ttracking_data:2020/12/13\ttracking_data:2020/12/14\ttracking_data:2020/12/15\ttracking_data:2020/12/16\ttracking_data:2020/12/17\ttracking_data:2020/12/18\ttracking_data:2020/12/19\ttracking_data:2020/12/20\ttracking_data:2020/12/21\ttracking_data:2020/12/22\ttracking_data:2020/12/23\ttracking_data:2020/12/24\ttracking_data:2020/12/25\ttracking_data:2020/12/26\ttracking_data:2020/12/27\ttracking_data:2020/12/28\ttracking_data:2020/12/29\ttracking_data:2020/12/30\ttracking_data:2020/12/31\ttracking_data:2021/01/05\ttracking_data:2021/01/06\ttracking_data:2021/01/07\ttracking_data:2021/01/08\ttracking_data:2021/01/09\ttracking_data:2021/01/10\ttracking_data:2021/01/11\ttracking_data:2021/01/12\ttracking_data:2021/01/13\ttracking_data:2021/01/14\ttracking_data:2021/01/15\ttracking_data:2021/01/16\ttracking_data:2021/01/17\ttracking_data:2021/01/18\ttracking_data:2021/01/19\ttracking_data:2021/01/20\ttracking_data:2021/01/21\ttracking_data:2021/01/22\ttracking_data:2021/01/23\ttracking_data:2021/01/24\ttracking_data:2021/01/25\ttracking_data:2021/01/26\ttracking_data:2021/01/27\ttracking_data:2021/01/28\ttracking_data:2021/01/29\ttracking_data:2021/01/30\ttracking_data:2021/01/31\ttracking_data:2021/02/04\ttracking_data:2021/02/05\ttracking_data:2021/02/06\ttracking_data:2021/02/07\ttracking_data:2021/02/08\ttracking_data:2021/02/09\ttracking_data:2021/02/10\ttracking_data:2021/02/11\ttracking_data:2021/02/12\ttracking_data:2021/02/13\ttracking_data:2021/02/14\ttracking_data:2021/02/15\ttracking_data:2021/02/16\ttracking_data:2021/02/17\ttracking_data:2021/02/18\ttracking_data:2021/02/19\ttracking_data:2021/02/20\ttracking_data:2021/02/21\ttracking_data:2021/02/22\ttracking_data:2021/02/23\ttracking_data:2021/02/24\ttracking_data:2021/02/25\ttracking_data:2021/02/26\ttracking_data:2021/02/27\ttracking_data:2021/02/28\ttracking_data:2021/03/01\ttracking_data:2021/03/02\ttracking_data:2021/03/03\ttracking_data:2021/03/04\ttracking_data:2021/03/05\ttracking_data:2021/03/06\ttracking_data:2021/03/07\ttracking_data:2021/03/08\ttracking_data:2021/03/09\ttracking_data:2021/03/10\ttracking_data:2021/03/11\ttracking_data:2021/03/12\ttracking_data:2021/03/13\ttracking_data:2021/03/14\ttracking_data:2021/03/15\ttracking_data:2021/03/16\ttracking_data:2021/03/17\ttracking_data:2021/03/18\ttracking_data:2021/03/19\ttracking_data:2021/03/20\ttracking_data:2021/03/21\ttracking_data:2021/03/22\ttracking_data:2021/03/23\ttracking_data:2021/03/24\ttracking_data:2021/03/25\ttracking_data:2021/03/26\ttracking_data:2021/03/27\ttracking_data:2021/03/28\ttracking_data:2021/03/29\ttracking_data:2021/03/30\ttracking_data:2021/03/31\ttracking_data:2021/04/01\ttracking_data:2021/04/02\ttracking_data:2021/04/03\ttracking_data:2021/04/04\ttracking_data:2021/04/05\ttracking_data:2021/04/06\ttracking_data:2021/04/07';
  const dates = input
    .split('\t')
    .filter((x) => x.includes('tracking_data'))
    .map((x) => x.replace('tracking_data:', ''));

  for (const date of dates) {
    const [year, month, day] = date.split('/');
    const query = `ALTER TABLE s3_athena.tracking_data ADD PARTITION (year='${year}', month='${month}', day='${day}', dt='${year}-${month}-${day}') location 's3://porsche-design-system-athena/tracking-data/${year}/${month}/${day}/'`;

    await athenaExpress
      .query(query)
      .then((data) => {
        console.log('Data:', data);
      })
      .catch((err) => {
        console.log('Error:', err);
      });
  }

  console.log('Finished creating new Athena partition');
};
