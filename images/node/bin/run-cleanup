#!/usr/bin/env bash

set -o errexit
set -o pipefail

SCRIPT_DIR="$(cd `dirname ${0}` && pwd)"
source "${SCRIPT_DIR}/../shared/ensure-github-credentials.sh"

if [[ -z "${GITHUB_REPOSITORY}" ]]; then
  echo "Please provide the \$GITHUB_REPOSITORY environment variable."
  exit 1
fi

if [[ -z "${GITHUB_ACTOR}" ]]; then
  echo "Please provide the \$GITHUB_ACTOR environment variable."
  exit 1
fi

setup_github() {
  git config --global user.name "${GITHUB_ACTOR}"
  git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
}

checkout_gh_pages() {
  git clone --single-branch -b gh-pages "git@github.com:${GITHUB_REPOSITORY}.git" "/opt/porsche-ui-kit-gh-pages"
}

remove_issue_deployments() {
  find "/opt/porsche-ui-kit-gh-pages/issue/*" -type d -ctime +14 | xargs rm -rf
}

setup_github
checkout_gh_pages
remove_issue_deployments
exec bash
