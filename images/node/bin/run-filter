#!/usr/bin/env bash

set -o errexit
set -o pipefail

echo "************** START"

SCRIPT_DIR="$(cd `dirname ${0}` && pwd)"
source "${SCRIPT_DIR}/../shared/ensure-github-credentials.sh"

git config --global user.name "${GITHUB_ACTOR}"
git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

git remote set-url origin "git@github.com:${GITHUB_REPOSITORY}.git"

echo "$(git remote show origin | grep "HEAD branch" | sed "s/.*: //")"

echo "************** END"

if [[ -z "${GITHUB_REF}" ]]; then
  echo "Please provide the \$GITHUB_REF environment variable."
  exit 1
fi

if [[ -z "${GIT_FILTER}" ]]; then
  echo "Please provide the \$GIT_FILTER environment variable."
  exit 1
fi

if [[ "${GITHUB_REF}" =~ ${GIT_FILTER} ]]; then
  echo "${GITHUB_REF} matches ${GIT_FILTER}"
  exit 0
else
  echo "${GITHUB_REF} does not match ${GIT_FILTER}"
  exit 78
fi
