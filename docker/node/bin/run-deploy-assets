#!/usr/bin/env bash

set -o errexit
set -o pipefail

SCRIPT_DIR="$(cd `dirname ${0}` && pwd)"

source "${SCRIPT_DIR}/../shared/ensure-cdn-credentials.sh"

echo "task: [$(date)] \"upload assets to cdn\""

# todo: we shouldn't get the key each time, but save the expected keys and check against
#       them to prevent man in the middle attacks
ssh-keygen -f "/root/.ssh/known_hosts" -R "rsync.ams.B2820.taucdn.net"
ssh -o StrictHostKeyChecking=no ${CDN_USER}@rsync.ams.B2820.taucdn.net "mkdir -p /assets/porsche-design-system/test/"

function upload {
  ssh-keygen -f "/root/.ssh/known_hosts" -R "rsync.ams.B2820.taucdn.net"
  rsync -avp -e "ssh -v -p22 -oUserKnownHostsFile=/dev/null -oStrictHostKeyChecking=no" "${1}" ${CDN_USER}@rsync.ams.B2820.taucdn.net:"/assets/porsche-design-system/test/${2}"
}

upload ./packages/marque/dist/marque/* marque/
upload ./packages/marque/dist/icons/* icons/
upload ./packages/fonts/dist/fonts/font-face.min.*.css fonts/
upload ./packages/fonts/dist/fonts/*.woff fonts/
upload ./packages/fonts/dist/fonts/*.woff2 fonts/
