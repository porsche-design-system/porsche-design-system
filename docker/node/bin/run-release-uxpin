#!/usr/bin/env bash

set -o errexit
set -o pipefail

if [[ -z "${UXPIN_TOKEN}" ]]; then
  echo "Please provide the \$UXPIN_TOKEN environment variable."
  exit 1
fi

publish() {
  echo "task: [$(date)] \"publish\""
  pushd "./packages/components-react/projects/uxpin-wrapper"
    branchParam=''
    if [[ "${P_CURRENT_BRANCH}" != "master" ]]; then
      branchParam=" --branch ${P_CURRENT_BRANCH}"
    fi
    result=$(./node_modules/.bin/uxpin-merge push --token "${UXPIN_TOKEN}"${branchParam})
    echo $result
  popd

  if [[ ${result} == *"Library bundle uploaded successfully!"* ]]; then
    return 0 # true
  else
    return 1 # false
  fi
}

P_CURRENT_BRANCH="${GITHUB_REF:11}" # strip first 11 characters from "refs/heads/issue/1405"

if publish; then
  echo "New version of components-uxpin published ðŸŽ‰"
else
  echo "Publishing new version of components-uxpin failed ðŸ˜¢"
  exit 1
fi
