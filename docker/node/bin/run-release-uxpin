#!/usr/bin/env bash

set -o errexit
set -o pipefail

if [[ -z "${UXPIN_TOKEN_DEV}" ]]; then
  echo "Please provide the \UXPIN_TOKEN_DEV environment variable."
  exit 1
fi

if [[ -z "${UXPIN_TOKEN_LATEST}" ]]; then
  echo "Please provide the \UXPIN_TOKEN_LATEST environment variable."
  exit 1
fi

publish() {
  echo "task: [$(date)] \"publish\""
  pushd "./packages/components-react/projects/uxpin-wrapper"
    token=$UXPIN_TOKEN_LATEST
    branchParam=""

    if [[ "${P_CURRENT_BRANCH}" != "master" ]]; then
      token=$UXPIN_TOKEN_DEV
      echo "Using UXPIN_TOKEN_DEV"

      branchParam="--branch ${P_CURRENT_BRANCH}"
      echo "Adding param:${branchParam}"
    else
      echo "Using UXPIN_TOKEN_LATEST"
    fi

    result=$(./node_modules/.bin/uxpin-merge push --token ${token} ${branchParam})
    echo $result
  popd

  if [[ ${result} == *"Library bundle uploaded successfully!"* ]]; then
    return 0 # true
  else
    return 1 # false
  fi
}

P_CURRENT_BRANCH="${GITHUB_REF:11}" # strip first 11 characters from "refs/heads/issue/1405"

if publish; then
  echo "New version of components-uxpin published ðŸŽ‰"
else
  echo "Publishing new version of components-uxpin failed ðŸ˜¢"
  exit 1
fi
