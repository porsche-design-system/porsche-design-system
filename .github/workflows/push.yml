on:
  push:
    branches:
      - master
      - v*
      - issue/*
      - housekeeping/*
      - release/*
name: 'Porsche Design System'
jobs:
  components-js:
    name: 'Components JS'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Get yarn cache'
        id: yarn-cache
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - name: 'Cache node_modules'
        uses: actions/cache@v1
        with:
          path: ${{ steps.yarn-cache.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-
      - name: 'Install'
        uses: ./docker/node/
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
        with:
          entrypoint: run-install
      - name: 'Build'
        uses: ./docker/node/
        with:
          entrypoint: run-build
      - name: 'Lint'
        uses: ./docker/node/
        with:
          entrypoint: run-lint
          args: --components-js
      - name: 'Unit Test'
        uses: ./docker/node/
        with:
          entrypoint: run-test-unit
          args: --components-js
      - name: 'E2E Test'
        uses: ./docker/node/
        with:
          entrypoint: run-test-e2e
          args: --components-js
      - name: 'VRT Test'
        uses: ./docker/node/
        with:
          entrypoint: run-test-vrt
          args: --components-js
      - name: 'VRT Regression'
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: components-js-vrt-regression
          path: ./packages/components-js/tests/vrt/results
  components-angular:
    name: 'Components Angular'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Get yarn cache'
        id: yarn-cache
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - name: 'Cache node_modules'
        uses: actions/cache@v1
        with:
          path: ${{ steps.yarn-cache.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-
      - name: 'Install'
        uses: ./docker/node/
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
        with:
          entrypoint: run-install
      - name: 'Build'
        uses: ./docker/node/
        with:
          entrypoint: run-build
      - name: 'VRT Test'
        uses: ./docker/node/
        with:
          entrypoint: run-test-vrt
          args: --components-angular
      - name: 'VRT Regression'
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: components-angular-vrt-regression
          path: ./packages/components-angular/tests/vrt/results
      - name: 'Store build artifact'
        uses: actions/upload-artifact@v2
        with:
          name: components-angular-build
          path: ./packages/components-angular/dist/components-wrapper
  components-react:
    name: 'Components React'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Get yarn cache'
        id: yarn-cache
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - name: 'Cache node_modules'
        uses: actions/cache@v1
        with:
          path: ${{ steps.yarn-cache.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-
      - name: 'Install'
        uses: ./docker/node/
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
        with:
          entrypoint: run-install
      - name: 'Build'
        uses: ./docker/node/
        with:
          entrypoint: run-build
      - name: 'Mock Test'
        uses: ./docker/node/
        with:
          entrypoint: run-test-mocks
          args: --components-react
      - name: 'VRT Test'
        uses: ./docker/node/
        with:
          entrypoint: run-test-vrt
          args: --components-react
      - name: 'VRT Regression'
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: components-react-vrt-regression
          path: ./packages/components-react/tests/vrt/results
  storefront:
    name: 'Storefront'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Get yarn cache'
        id: yarn-cache
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - name: 'Cache node_modules'
        uses: actions/cache@v1
        with:
          path: ${{ steps.yarn-cache.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-
      - name: 'Install'
        uses: ./docker/node/
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
        with:
          entrypoint: run-install
      - name: 'Build'
        uses: ./docker/node/
        with:
          entrypoint: run-build
      - name: 'Lint'
        uses: ./docker/node/
        with:
          entrypoint: run-lint
          args: --storefront
      - name: 'Unit Test'
        uses: ./docker/node/
        with:
          entrypoint: run-test-unit
          args: --storefront
      - name: 'E2E Test'
        uses: ./docker/node/
        with:
          entrypoint: run-test-e2e
          args: --storefront
      - name: 'VRT Test'
        uses: ./docker/node/
        with:
          entrypoint: run-test-vrt
          args: --storefront
      - name: 'VRT Regression'
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: storefront-vrt-regression
          path: ./packages/storefront/tests/vrt/results
      - name: 'Build components-js prod'
        uses: ./docker/node/
        with:
          entrypoint: run-build
          args: --components-js-prod
      - name: 'Build storefront prod'
        uses: ./docker/node/
        with:
          entrypoint: run-build
          args: --storefront
      - name: 'Store build artifact'
        uses: actions/upload-artifact@v2
        with:
          name: storefront-build
          path: ./packages/storefront/dist

  utilities:
    name: 'Utilities'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Get yarn cache'
        id: yarn-cache
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - name: 'Cache node_modules'
        uses: actions/cache@v1
        with:
          path: ${{ steps.yarn-cache.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-
      - name: 'Install'
        uses: ./docker/node/
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
        with:
          entrypoint: run-install
      - name: 'Build'
        uses: ./docker/node/
        with:
          entrypoint: run-build
          args: --utilities
      - name: 'Unit Test'
        uses: ./docker/node/
        with:
          entrypoint: run-test-unit
          args: --utilities
      - name: 'VRT Test'
        uses: ./docker/node/
        with:
          entrypoint: run-test-vrt
          args: --utilities
      - name: 'VRT Regression'
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: utilities-vrt-regression
          path: ./packages/utilities/tests/vrt/results
  marque:
    name: 'Marque'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Install'
        uses: ./docker/node/
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
        with:
          entrypoint: run-install
      - name: 'Build'
        uses: ./docker/node/
        with:
          entrypoint: run-build
          args: --marque
      - name: 'Store build artifact'
        uses: actions/upload-artifact@v2
        with:
          name: marque-build
          path: ./packages/marque/dist/marque
  icons:
    name: 'Icons'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Install'
        uses: ./docker/node/
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
        with:
          entrypoint: run-install
      - name: 'Build'
        uses: ./docker/node/
        with:
          entrypoint: run-build
          args: --icons
      - name: 'Store build artifact'
        uses: actions/upload-artifact@v2
        with:
          name: icons-build
          path: ./packages/icons/dist/icons
  fonts:
    name: 'Fonts'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Install'
        uses: ./docker/node/
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
        with:
          entrypoint: run-install
      - name: 'Build utilities'
        uses: ./docker/node/
        with:
          entrypoint: run-build
          args: --utilities
      - name: 'Build'
        uses: ./docker/node/
        with:
          entrypoint: run-build
          args: --fonts
      - name: 'Store build artifact'
        uses: actions/upload-artifact@v2
        with:
          name: fonts-build
          path: ./packages/fonts/dist/fonts
  assets-deployment:
    name: 'Assets Deployment'
    needs: [marque, icons, fonts]
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Restore marque build artifact'
        uses: actions/download-artifact@v2
        with:
          name: marque-build
          path: ./packages/marque/dist/marque
      - name: 'Restore icons build artifact'
        uses: actions/download-artifact@v2
        with:
          name: icons-build
          path: ./packages/icons/dist/icons
      - name: 'Restore fonts build artifact'
        uses: actions/download-artifact@v2
        with:
          name: fonts-build
          path: ./packages/fonts/dist/fonts
      - name: 'Deploy'
        uses: ./docker/node/
        env:
          CDN_USER: ${{ secrets.CDN_USER }}
          CDN_SSH_KEY: ${{ secrets.CDN_SSH_KEY }}
        with:
          entrypoint: run-deploy-assets
  storefront-deployment:
    name: 'Storefront Deployment'
    needs: [components-js, components-angular, components-react, storefront, utilities, assets-deployment]
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Restore build artifact'
        uses: actions/download-artifact@v2
        with:
          name: storefront-build
          path: ./packages/storefront/dist
      - name: 'Deploy'
        uses: ./docker/node/
        env:
          GIT_DEPLOY_KEY: ${{ secrets.GIT_DEPLOY_KEY }}
        with:
          entrypoint: run-deploy-storefront
  components-js-release:
    name: 'Release components-js'
    needs: [storefront-deployment]
    if: startsWith( github.ref, 'refs/heads/v') || github.ref === 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Install'
        uses: ./docker/node/
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
        with:
          entrypoint: run-install
      - name: 'Build'
        uses: ./docker/node/
        with:
          entrypoint: run-build
      - name: 'Build components-js prod'
        uses: ./docker/node/
        with:
          entrypoint: run-build
          args: --components-js-prod
      - name: 'Publish npm package'
        uses: ./docker/node/
        with:
          entrypoint: run-release
          args: packages/components-js
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
  components-angular-release:
    name: 'Release components-angular'
    needs: [components-js-release]
    if: startsWith( github.ref, 'refs/heads/v') || github.ref === 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Restore build artifact'
        uses: actions/download-artifact@v2
        with:
          name: components-angular-build
          path: ./packages/components-angular/dist/components-wrapper
      - name: 'Publish npm package'
        uses: ./docker/node/
        with:
          entrypoint: run-release
          args: packages/components-angular/dist/components-wrapper
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
  components-react-release:
    name: 'Release components-react'
    needs: [components-js-release]
    if: startsWith( github.ref, 'refs/heads/v') || github.ref === 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Install'
        uses: ./docker/node/
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
        with:
          entrypoint: run-install
      - name: 'Build'
        uses: ./docker/node/
        with:
          entrypoint: run-build
      - name: 'Publish npm package'
        uses: ./docker/node/
        with:
          entrypoint: run-release
          args: packages/components-react/projects/components-wrapper
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
  utilities-release:
    name: 'Release utilities'
    needs: [storefront-deployment]
    if: startsWith( github.ref, 'refs/heads/v') || github.ref === 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Install'
        uses: ./docker/node/
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
        with:
          entrypoint: run-install
      - name: 'Build'
        uses: ./docker/node/
        with:
          entrypoint: run-build
          args: --utilities
      - name: 'Publish npm package'
        uses: ./docker/node/
        with:
          entrypoint: run-release
          args: packages/utilities/projects/utilities
        env:
          PORSCHE_NPM_REGISTRY_TOKEN: ${{ secrets.PORSCHE_NPM_REGISTRY_TOKEN }}
